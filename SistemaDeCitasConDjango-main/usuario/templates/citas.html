{% load static %}

<!-- Plantilla de la cabecera de la página -->
{% include "cabecera-usuario.html" %}

<!-- Título de la página -->
<h1 class="text-center border border-dark p-3 paginas-titulo">
    Crear Cita
</h1>

<!-- Línea separadora -->
<hr />

<!-- Contenedor principal -->
<h3 class="text-center">Selecciona los datos de la cita</h3>

<!-- Formulario de creación de cita -->
<form action="{% url 'cita' %}" method="POST" class="form">
    {% csrf_token %}
    <input type="hidden" name="id_usu" value="{{ request.user.id }}">
    <input type="hidden" name="cita_estado" value="True">
    <input type="hidden" name="id_pac" value="{{ request.user.paciente_id}}">

    <table class="table table-bordered">
        <thead>
            <tr>
                <th scope="col">Datos de la cita</th>
                <th scope="col">Disponibilidad de citas</th>
            </tr>
        </thead>
        <tbody>
            <!-- Campo: Servicio -->
            <tr>
                <td><label for="servicio">Servicio</label></td>
                <td>
                    <select class="form-control" id="servicio" name="id_servicio" required>
                        <option value="" selected>Elige un servicio</option> <!-- Mensaje por defecto -->
                        {% if listaServicios %}
                            {% for servicio in listaServicios %}
                                <option value="{{ servicio.id_servicio }}">{{ servicio.nombre_servicio }}</option>
                            {% endfor %}
                        {% else %}
                            <option value="">No hay servicios disponibles</option>
                        {% endif %}
                    </select>
                </td>
            </tr>
        
            <!-- Campo: Profesional -->
            <tr>
                <td><label for="profesional">Profesional</label></td>
                <td>
                    <select class="form-control" id="profesional" name="id_prof" required>
                        <option value="">Selecciona un servicio primero</option>
                    </select>
                </td>
            </tr>

            <!-- Campo: Día de la cita -->
            <tr>
                <td><label for="dia">Día de la cita</label></td>
                <td>
                    <input class="form-control" type="date" id="dia" name="dia_cit" required>
                </td>
            </tr>

            <!-- Campo: Hora -->

            <tr>
                <td><label for="hora">Hora de la cita</label></td>
                <td>
                    <select class="form-control" id="hora" name="id_hora" required>
                        <option value="">Selecciona una fecha Primero</option>
                    </select>
                </td>
            </tr>
           
            <!-- Campo: Nota -->
            <tr>
                <td><label for="nota">Nota/Descripción</label></td>
                <td>
                    <textarea class="form-control" id="nota_cit" name="nota_cit" rows="3" placeholder="Escribe una nota para la cita..." style="resize: none;"></textarea>
                </td>
            </tr>
            <tr>
                <td><label for="lugares">lugar de la cita</label></td>
                <td>
                    <select class="form-control" id="lugares" name="id_lugar" required>
                        <option value="" selected>Este es su lugar de cita</option> 
                        {% if listaLugares %}
                            {% for lugares in listaLugares %}
                                <option value="{{ lugares.lugares}}">{{ lugares.nombre_lugar }}</option>
                            {% endfor %}
                        {% else %}
                            <option value="">No hay lugar</option>
                        {% endif %}
                    </select>
                </td>
            </tr>
            {% if form.id_hora.errors %}
        <div class="alert alert-danger" role="alert">
            {% for error in form.id_hora.errors %}
                <p>{{ error }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Mostrar errores globales -->
    {% if messages %}
        <div class="alert alert-danger">
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}

            <!-- Botón: Crear Cita -->
            <tr>
                <td colspan="2" class="text-center">
                    <input type="submit" value="Crear Cita" class="btn btn-success">
                </td>
            </tr>
        </tbody>
    </table>
</form>

<!-- Script para actualizar profesionales según el servicio -->
<script>
    document.getElementById('servicio').addEventListener('change', function() {
        const servicioId = this.value;
        const profesionalSelect = document.getElementById('profesional');

        if (servicioId) {
            fetch(`{% url 'get_profesionales' %}?id_servicio=${servicioId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar los profesionales');
                    }
                    return response.json();
                })
                .then(data => {
                    profesionalSelect.innerHTML = '<option value="">Seleccione un profesional</option>';
                    data.forEach(item => {
                        profesionalSelect.innerHTML += `<option value="${item.id_prof}">${item.nombre_prof}</option>`;
                    });
                })
                .catch(error => {
                    console.error(error);
                    profesionalSelect.innerHTML = '<option value="">Error al cargar los profesionales</option>';
                });
        } else {
            profesionalSelect.innerHTML = '<option value="">Selecciona un servicio primero</option>';
        }
    });
    document.getElementById('dia').addEventListener('change', function() {
        const profesionalId = document.getElementById('profesional').value;
        const diaCit = this.value;  // Fecha seleccionada
        const horasSelect = document.getElementById('hora');
    
        if (profesionalId && diaCit) {
            fetch(`/get_horas/?id_prof=${profesionalId}&dia_cit=${diaCit}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar las horas');
                    }
                    return response.json();
                })
                .then(data => {
                    horasSelect.innerHTML = ''; // Limpia las opciones
                    if (data.length > 0) {
                        // Si hay horas disponibles, agregarlas al select
                        horasSelect.innerHTML = '<option value="">Seleccione una Hora</option>';
                        data.forEach(item => {
                            horasSelect.innerHTML += `<option value="${item.id_hora}">${item.rango_horas}</option>`;
                        });
                    } else {
                        // Si no hay horas disponibles, mostrar el mensaje
                        horasSelect.innerHTML = '<option value="">No hay horas disponibles para esa fecha</option>';
                    }
                })
                .catch(error => {
                    console.error(error);
                    horasSelect.innerHTML = '<option value="">Error al cargar las horas</option>';
                });
        } else {
            horasSelect.innerHTML = '<option value="">Selecciona un profesional y una fecha primero</option>';
        }
    });
    document.getElementById('servicio').addEventListener('change', function() {
        const servicioId = this.value;
        const lugaresSelect = document.getElementById('lugares');

        if (servicioId) {
            fetch(`{% url 'get_lugares' %}?id_servicio=${servicioId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar los consultorios');
                    }
                    return response.json();
                })
                .then(data => {
                    lugaresSelect.innerHTML = '<option value="">Seleccione un consultorio</option>';
                    data.forEach(item => {
                        lugaresSelect.innerHTML += `<option value="${item.id_lugar}">${item.nombre_lugar}</option>`;
                    });
                })
                .catch(error => {
                    console.error(error);
                    lugaresSelect.innerHTML = '<option value="">Error al cargar el consultorio</option>';
                });
        } else {
            lugaresSelect.innerHTML = '<option value="">Selecciona un servicio primero</option>';
        }
    });
    
</script>